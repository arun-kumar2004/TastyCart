{% extends "base.html" %} 
{% load static %}
{% load socialaccount %}

{% block content %}
<div class="bg-gray-100 flex items-center justify-center min-h-screen p-4">
  <div
    class="bg-white p-8 rounded-lg shadow-xl w-full max-w-md transform transition-all duration-500 hover:scale-105"
  >
    <h2 class="text-3xl font-bold text-center text-gray-800 mb-6">
      Update Your Profile âœ¨
    </h2>

    <div class="flex flex-col items-center mb-2">
      <label for="profilePhoto" class="cursor-pointer inline-block relative">
        <div
          id="photoPreview"
          class="w-32 h-32 mx-auto rounded-full border-2 border-gray-300 flex items-center justify-center overflow-hidden bg-gray-100 hover:bg-gray-200 transition-all relative"
        >
          <span
            id="photoText"
            class="text-gray-500 text-center px-2 absolute z-10"
          >
            Upload Your Profile Pic
          </span>

          <img
            id="profileImg"
            src="{% if user.profile_pic %}{{ user.profile_pic.url }}{% else %}{% static 'images/profile_pic.png' %}{% endif %}"
            alt="Profile Photo"
            class="w-full h-full object-cover {% if not user.profile_pic %}hidden{% endif %}"
          />

          {% if not user.profile_pic %}
          <img
            id="placeholderFrame"
            src="{% static 'images/profile_pic.png' %}"
            alt="Profile Frame"
            class="w-full h-full object-cover"
          />
          {% endif %}
        </div>
        <input type="file" id="profilePhoto" name="profile_pic" class="hidden" />
      </label>

      <p class="text-gray-500 text-sm mt-2 text-center">
        To update your image, click on the image above
      </p>

      <div
        id="progressContainer"
        class="w-full bg-gray-300 rounded-full h-3 mt-4 hidden"
      >
        <div
          id="progressBar"
          class="bg-green-500 h-3 rounded-full w-0"
        ></div>
      </div>
    </div>

    <form id="updateForm" enctype="multipart/form-data" method="post">
      {% csrf_token %}
      <div class="mb-4">
        <label class="block text-gray-700 font-semibold mb-2">Full Name</label>
        <input
          type="text"
          id="fullName"
          name="fullName"
          value="{{ user.first_name }}"
          class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
          placeholder="Enter your full name"
        />
      </div>

      <div class="mb-4">
        <label class="block text-gray-700 font-semibold mb-2">Phone Number</label>
        <input
          type="tel"
          id="phoneNumber"
          name="phoneNumber"
          value="{{ user.phone }}"
          class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
          placeholder="+91 9876543210"
        />
      </div>

      <div class="mb-4">
        <label class="block text-gray-700 font-semibold mb-2">Email Address</label>
        <input
          type="email"
          id="email"
          name="email"
          value="{{ user.email }}"
          class="w-full p-3 border border-gray-300 rounded-lg bg-gray-200 text-gray-600 cursor-not-allowed focus:outline-none"
          placeholder="Enter your email"
          disabled
        />
      </div>

      <div class="mb-4 relative">
        <label class="block text-gray-700 font-semibold mb-2">Delivery Address</label>
        <textarea
          id="deliveryAddress"
          name="deliveryAddress"
          rows="3"
          class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
          placeholder="Enter your address"
        >{{ user.address }}</textarea>
        <span
          id="locationBtn"
          class="absolute right-3 top-9 cursor-pointer text-blue-500 text-xl"
        >ğŸ“</span>
      </div>

      <div class="mb-4 relative">
        <label class="block text-gray-700 font-semibold mb-2">Current Password (required to authorize)</label>
        <input
          type="password"
          id="currentPassword"
          name="currentPassword"
          class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 pr-12"
          placeholder="Enter your current password to authorize update"
        />
        <span
          id="toggleCurrentPassword"
          class="absolute right-3 top-3 cursor-pointer text-xl"
        >ğŸ‘ï¸</span>
      </div>

      <div class="mb-6">
        <a
          id="forgotPassword"
          href="{% url 'password_reset' %}"
          class="text-blue-500 text-sm hidden"
        >Forgot password?</a>
      </div>

      <button
        type="submit"
        id="updateBtn"
        class="w-full bg-gray-400 text-white font-bold py-3 rounded-lg cursor-not-allowed"
        disabled
      >
        ğŸš« Update Details
      </button>
    </form>
  </div>
</div>



<script>
const currentPasswordInput = document.getElementById("currentPassword");
const toggleCurrentPassword = document.getElementById("toggleCurrentPassword");
const updateBtn = document.getElementById("updateBtn");
const locationBtn = document.getElementById("locationBtn");
const forgotPasswordLink = document.getElementById("forgotPassword");
const progressContainer = document.getElementById("progressContainer");
const progressBar = document.getElementById("progressBar");
const updateForm = document.getElementById("updateForm");

let wrongAttempts = 0;

// ----------------------
// Profile pic preview
const profilePhotoInput = document.getElementById("profilePhoto");
const profileImg = document.getElementById("profileImg");
const photoText = document.getElementById("photoText");
const placeholderFrame = document.getElementById("placeholderFrame");

{% if user.profile_pic %}
    profileImg.src = "{{ user.profile_pic.url }}?{{ user.profile_pic.name }}";
    profileImg.classList.remove("hidden");
if (placeholderFrame) placeholderFrame.classList.add("hidden");
if (photoText) photoText.remove();
{% endif %}

// File input change
profilePhotoInput.addEventListener("change", function () {
  const file = this.files[0];
  if (!file) return;

  const reader = new FileReader();
  reader.onload = function (e) {
    profileImg.src = e.target.result;
    profileImg.classList.remove("hidden");
    if (photoText) photoText.remove();
    if (placeholderFrame) placeholderFrame.classList.add("hidden");
  };
  reader.readAsDataURL(file);

  // Simulate progress
  progressContainer.classList.remove("hidden");
  let progress = 0;
  const interval = setInterval(() => {
    progress += 10;
    progressBar.style.width = progress + "%";
    if (progress >= 100) {
      clearInterval(interval);
      setTimeout(() => progressContainer.classList.add("hidden"), 500);
    }
  }, 100);
});

// ----------------------
// AJAX form submit
updateForm.addEventListener("submit", (e) => {
  e.preventDefault();
  const formData = new FormData(updateForm);
  const csrfToken = document.querySelector("[name=csrfmiddlewaretoken]").value;

  const xhr = new XMLHttpRequest();
  xhr.open("POST", updateForm.action || window.location.href, true);
  xhr.setRequestHeader("X-Requested-With", "XMLHttpRequest");
  xhr.setRequestHeader("X-CSRFToken", csrfToken);

  xhr.upload.onprogress = (event) => {
    if (event.lengthComputable) {
      const percent = Math.round((event.loaded / event.total) * 100);
      progressBar.style.width = percent + "%";
      progressContainer.classList.remove("hidden");
    }
  };

  xhr.onload = () => {
    let result = {};
    try { result = JSON.parse(xhr.responseText); } 
    catch (err) {
      showToast("error-toast", 5000, "Unexpected server response.");
      progressContainer.classList.add("hidden");
      progressBar.style.width = "0%";
      return;
    }

   if (result.success) {
    // Update image src to new image URL dynamically
    if (result.new_image_url) {
        profileImg.src = result.new_image_url + "?t=" + new Date().getTime(); // cache-buster
        profileImg.classList.remove("hidden");
        if (placeholderFrame) placeholderFrame.classList.add("hidden");
        if (photoText) photoText.remove();
    }

    progressBar.style.width = "100%";
    showToast("success-toast", 3000, result.message);
    setTimeout(() => window.history.back(), 1500);
}
 else {
      wrongAttempts++;
      progressBar.style.width = "0%";
      showToast("error-toast", 5000, "âŒ " + (result.message || "Update failed."));
      if (wrongAttempts >= 3) {
        forgotPasswordLink.classList.remove("hidden");
      }
    }
    progressContainer.classList.add("hidden");
    progressBar.style.width = "0%";
  };

  xhr.onerror = () => {
    showToast("error-toast", 5000, "Network error while uploading. Try again.");
    progressContainer.classList.add("hidden");
    progressBar.style.width = "0%";
  };

  xhr.send(formData);
});

// ----------------------
// Enable update button only if current password filled
currentPasswordInput.addEventListener("input", () => {
  if (currentPasswordInput.value.trim()) {
    updateBtn.disabled = false;
    updateBtn.classList.remove("bg-gray-400", "cursor-not-allowed");
    updateBtn.classList.add("bg-green-500");
    updateBtn.textContent = "Update Details";
  } else {
    updateBtn.disabled = true;
    updateBtn.classList.remove("bg-green-500");
    updateBtn.classList.add("bg-gray-400", "cursor-not-allowed");
    updateBtn.textContent = "Update Details";
  }
});

// Toggle password visibility
toggleCurrentPassword.addEventListener("click", () => {
  if (currentPasswordInput.type === "password") {
    currentPasswordInput.type = "text";
    toggleCurrentPassword.textContent = "ğŸ‘";
  } else {
    currentPasswordInput.type = "password";
    toggleCurrentPassword.textContent = "ğŸ‘ï¸";
  }
});

// Geolocation autofill
locationBtn.addEventListener("click", () => {
  if (navigator.geolocation) {
    navigator.geolocation.getCurrentPosition(
      (pos) => {
        const lat = pos.coords.latitude.toFixed(6);
        const lng = pos.coords.longitude.toFixed(6);
        document.getElementById("deliveryAddress").value = `${lat},${lng}`;
      },
      () => alert("Unable to fetch location")
    );
  } else {
    alert("Geolocation not supported");
  }
});
</script>


{% endblock %}
