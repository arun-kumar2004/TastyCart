{% extends "base.html" %}
{% load static %}
{% load socialaccount %}

{% block navbar %}{% endblock %}
{% block footer %}{% endblock %}

{% block content %}
<style>
@keyframes shake {
  0%, 100% { transform: translateX(0); }
  25% { transform: translateX(-5px); }
  50% { transform: translateX(5px); }
  75% { transform: translateX(-5px); }
}
.shake { animation: shake 0.3s; }

button[type="submit"]:hover {
  background: linear-gradient(to right, #4f46e5, #2563eb);
}
</style>

<div class="flex justify-center items-center min-h-screen bg-gradient-to-r from-blue-100 via-blue-200 to-blue-300">
  <div class="bg-white p-8 rounded-xl shadow-2xl max-w-md w-full">

    <!-- ‚úÖ Project Name with Home Link -->
    <div class="text-center mb-6">
      <a href="{% url 'home' %}" class="text-2xl font-bold text-blue-600 hover:text-blue-800">
        üç¥TastyCart
      </a>
    </div>

    <h2 class="text-3xl font-bold text-center mb-6 text-gray-800">Login</h2>

    <form id="login-form" method="post" action="{% url 'ajax_login' %}" class="space-y-4">
      {% csrf_token %}
      <input type="hidden" name="next" value="{{ request.GET.next }}">

      <div>
        <label for="id_username" class="block text-sm font-medium text-gray-700">Username / Email / Mobile</label>
        <input type="text" id="id_username" name="username" placeholder="Enter username"
          class="focus:ring-blue-500 focus:border-blue-500 block w-full sm:text-sm border-gray-300 rounded-md p-2">
      </div>

      <div>
        <label for="id_password" class="block text-sm font-medium text-gray-700">Password</label>
        <input type="password" id="id_password" name="password" placeholder="Enter password"
          class="focus:ring-blue-500 focus:border-blue-500 block w-full sm:text-sm border-gray-300 rounded-md p-2">
        <div class="text-right mt-1">
          <a href="{% url 'password_reset' %}" class="text-sm text-blue-600 hover:text-blue-500">Forgot password?</a>
        </div>
      </div>

      <button type="submit"
        class="w-full text-white font-bold py-2 px-4 rounded-lg bg-gradient-to-r from-purple-600 to-blue-500 transition-all duration-200">
        Login
      </button>
    </form>

    <div class="text-center mt-6 text-gray-500">
      <p>Or Login Using</p>
      <div class="mt-6">
          <a href="{% provider_login_url 'google' %}" 
            class="flex items-center justify-center bg-white border rounded-lg px-4 py-2 shadow hover:bg-gray-100 transition-colors duration-200">
              <img src="{% static 'images/google.png' %}" alt="Google" class="w-5 h-5 mr-2">
              <span class="text-gray-700">Login with Google</span>
          </a>
      </div>
    </div>

    <div class="text-center mt-6">
      <p class="text-gray-500">Don‚Äôt have an account?</p>
      <a href="{% url 'signup' %}" class="font-bold text-blue-600 hover:text-blue-500">Sign Up</a>
    </div>

  </div>
</div>

<!-- ‚úÖ Toast Include -->
{% include "includes/toast.html" %}

<script>
document.getElementById("login-form").addEventListener("submit", function (event) {
    event.preventDefault();
    const form = event.target;
    const formData = new FormData(form);
    const loginBtn = form.querySelector('button[type="submit"]');

    fetch(form.action, {
        method: "POST",
        body: formData,
        headers: { "X-CSRFToken": formData.get("csrfmiddlewaretoken") }
    })
    .then(res => res.json())
    .then(data => {
        if (data.success) {
            document.getElementById("success-message").textContent = "‚úîÔ∏è Welcome " + data.user_name;
            const toast = document.getElementById("success-toast");
            const progressBar = document.getElementById("progress-bar");

            toast.classList.remove("hidden");

            let width = 100;
            const interval = setInterval(() => {
                width -= 5;
                progressBar.style.width = width + "%";
            }, 100);

            setTimeout(() => {
                clearInterval(interval);
                toast.classList.add("hidden");

                // Use global back instead of redirect_to
                window.history.back();

            }, 2000);

        } else if (data.oauth_error) {
            showToast("oauth-error-toast", 3000);
        } else {
            showToast("error-toast", 2500, "‚ùå Invalid username or password, try again");
            form.reset();
            loginBtn.classList.add('shake', 'bg-red-500');
            setTimeout(() => {
                loginBtn.classList.remove('shake', 'bg-red-500');
            }, 1000);
        }
    })
    .catch(err => {
        console.error(err);
        showToast("oauth-error-toast", 3000, "‚ö†Ô∏è Login error, please try again");
    });
});
</script>
{% endblock %}


